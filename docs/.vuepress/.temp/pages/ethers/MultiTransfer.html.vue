<template><div><Layout/><h1 id="_15-批量转账" tabindex="-1"><a class="header-anchor" href="#_15-批量转账"><span>15. 批量转账</span></a></h1>
<p>这一讲，我们将介绍用<code v-pre>ethers.js</code>进行批量转账。</p>
<h2 id="airdrop合约" tabindex="-1"><a class="header-anchor" href="#airdrop合约"><span>Airdrop合约</span></a></h2>
<p>这里简单介绍下<code v-pre>Airdrop</code>合约，细节可以去Solidity教程中看。我们会用到<code v-pre>2</code>个函数：</p>
<ul>
<li>
<p><code v-pre>multiTransferETH()</code>：批量发送<code v-pre>ETH</code>，包含<code v-pre>2</code>个参数：</p>
<ul>
<li><code v-pre>_addresses</code>：接收空投的用户地址数组（<code v-pre>address[]</code>类型）</li>
<li><code v-pre>_amounts</code>：空投数量数组，对应<code v-pre>_addresses</code>里每个地址的数量（<code v-pre>uint[]</code>类型）</li>
</ul>
</li>
<li>
<p><code v-pre>multiTransferToken()</code>函数：批量发送<code v-pre>ERC20</code>代币，包含<code v-pre>3</code>个参数：</p>
<ul>
<li><code v-pre>_token</code>：代币合约地址（<code v-pre>address</code>类型）</li>
<li><code v-pre>_addresses</code>：接收空投的用户地址数组（<code v-pre>address[]</code>类型）</li>
<li><code v-pre>_amounts</code>：空投数量数组，对应<code v-pre>_addresses</code>里每个地址的数量（<code v-pre>uint[]</code>类型）</li>
</ul>
</li>
</ul>
<p>我们在<code v-pre>Goerli</code>测试网部署了一个<code v-pre>Airdrop</code>合约，地址为：</p>
<div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre v-pre><code><span class="line">0x71C2aD976210264ff0468d43b198FD69772A25fa</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div></div></div><h2 id="批量转账" tabindex="-1"><a class="header-anchor" href="#批量转账"><span>批量转账</span></a></h2>
<p>下面我们写一个脚本，调用<code v-pre>Airdrop</code>合约将<code v-pre>ETH</code>（原生代币）和<code v-pre>WETH</code>（ERC20代币）转账给<code v-pre>20</code>个地址。</p>
<ol>
<li>
<p>创建HD钱包，用于批量生成地址。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n1. 创建HD钱包"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// 通过助记词生成HD钱包</span></span>
<span class="line"><span class="token keyword">const</span> mnemonic <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">air organ twist rule prison symptom jazz cheap rather dizzy verb glare jeans orbit weapon universe require tired sing casino business anxiety seminar hunt</span><span class="token template-punctuation string">`</span></span></span>
<span class="line"><span class="token keyword">const</span> hdNode <span class="token operator">=</span> ethers<span class="token punctuation">.</span>HDNodeWallet<span class="token punctuation">.</span><span class="token function">fromPhrase</span><span class="token punctuation">(</span>mnemonic<span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hdNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="@source/ethers/img/15-1.png" alt="HD钱包"></p>
</li>
<li>
<p>利用HD钱包，生成20个钱包地址。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n2. 通过HD钱包派生20个钱包"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> numWallet <span class="token operator">=</span> <span class="token number">20</span></span>
<span class="line"><span class="token comment">// 派生路径：m / purpose' / coin_type' / account' / change / address_index</span></span>
<span class="line"><span class="token comment">// 我们只需要切换最后一位address_index，就可以从hdNode派生出新钱包</span></span>
<span class="line"><span class="token keyword">let</span> basePath <span class="token operator">=</span> <span class="token string">"m/44'/60'/0'/0"</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> addresses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numWallet<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> hdNodeNew <span class="token operator">=</span> hdNode<span class="token punctuation">.</span><span class="token function">derivePath</span><span class="token punctuation">(</span>basePath <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> walletNew <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Wallet</span><span class="token punctuation">(</span>hdNodeNew<span class="token punctuation">.</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    addresses<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>walletNew<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>addresses<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> amounts <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>ethers<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"0.0001"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">发送数额：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>amounts<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="@source/ethers/img/15-2.png" alt="生成20个地址"></p>
</li>
<li>
<p>创建provider和wallet，发送代币用。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token keyword">const</span> <span class="token constant">ALCHEMY_GOERLI_URL</span> <span class="token operator">=</span> <span class="token string">'https://eth-goerli.alchemyapi.io/v2/GlaeWuylnNM3uuOo-SAwJxuwTdqHaY5l'</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>JsonRpcProvider</span><span class="token punctuation">(</span><span class="token constant">ALCHEMY_GOERLI_URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 利用私钥和provider创建wallet对象</span></span>
<span class="line"><span class="token comment">// 如果这个钱包没goerli测试网ETH了</span></span>
<span class="line"><span class="token comment">// 请使用自己的小号钱包测试，钱包地址: 0x338f8891D6BdC58eEB4754352459cC461EfD2a5E ,请不要给此地址发送任何ETH</span></span>
<span class="line"><span class="token comment">// 注意不要把自己的私钥上传到github上</span></span>
<span class="line"><span class="token keyword">const</span> privateKey <span class="token operator">=</span> <span class="token string">'0x21ac72b6ce19661adf31ef0d2bf8c3fcad003deee3dc1a1a64f5fa3d6b049c06'</span></span>
<span class="line"><span class="token keyword">const</span> wallet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Wallet</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">,</span> provider<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li>
<p>创建Airdrop合约。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token comment">// Airdrop的ABI</span></span>
<span class="line"><span class="token keyword">const</span> abiAirdrop <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">"function multiTransferToken(address,address[],uint256[]) external"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">"function multiTransferETH(address[],uint256[]) public payable"</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// Airdrop合约地址（Goerli测试网）</span></span>
<span class="line"><span class="token keyword">const</span> addressAirdrop <span class="token operator">=</span> <span class="token string">'0x71C2aD976210264ff0468d43b198FD69772A25fa'</span> <span class="token comment">// Airdrop Contract</span></span>
<span class="line"><span class="token comment">// 声明Airdrop合约</span></span>
<span class="line"><span class="token keyword">const</span> contractAirdrop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Contract</span><span class="token punctuation">(</span>addressAirdrop<span class="token punctuation">,</span> abiAirdrop<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li>
<p>创建WETH合约。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token comment">// WETH的ABI</span></span>
<span class="line"><span class="token keyword">const</span> abiWETH <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">"function balanceOf(address) public view returns(uint)"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">"function transfer(address, uint) public returns (bool)"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">"function approve(address, uint256) public returns (bool)"</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// WETH合约地址（Goerli测试网）</span></span>
<span class="line"><span class="token keyword">const</span> addressWETH <span class="token operator">=</span> <span class="token string">'0xB4FBF271143F4FBf7B91A5ded31805e42b2208d6'</span> <span class="token comment">// WETH Contract</span></span>
<span class="line"><span class="token comment">// 声明WETH合约</span></span>
<span class="line"><span class="token keyword">const</span> contractWETH <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Contract</span><span class="token punctuation">(</span>addressWETH<span class="token punctuation">,</span> abiWETH<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li>
<p>读取一个地址的ETH和WETH余额。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n3. 读取一个地址的ETH和WETH余额"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">//读取WETH余额</span></span>
<span class="line"><span class="token keyword">const</span> balanceWETH <span class="token operator">=</span> <span class="token keyword">await</span> contractWETH<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>addresses<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">WETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceWETH<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">//读取ETH余额</span></span>
<span class="line"><span class="token keyword">const</span> balanceETH <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span>addresses<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceETH<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="@source/ethers/img/15-3.png" alt="读取WETH和ETH持仓"></p>
</li>
<li>
<p>调用<code v-pre>multiTransferETH()</code>函数，给每个钱包转<code v-pre>0.0001 ETH</code>，可以看到发送后余额发生变化。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n4. 调用multiTransferETH()函数，给每个钱包转 0.0001 ETH"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// 发起交易</span></span>
<span class="line"><span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> contractAirdrop<span class="token punctuation">.</span><span class="token function">multiTransferETH</span><span class="token punctuation">(</span>addresses<span class="token punctuation">,</span> amounts<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> ethers<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"0.002"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// 等待交易上链</span></span>
<span class="line"><span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// console.log(`交易详情：`)</span></span>
<span class="line"><span class="token comment">// console.log(tx)</span></span>
<span class="line"><span class="token keyword">const</span> balanceETH2 <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span>addresses<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">发送后该钱包ETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceETH2<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="@source/ethers/img/15-4.png" alt="批量发送ETH"></p>
</li>
<li>
<p>调用multiTransferToken()函数，给每个钱包转 <code v-pre>0.0001 WETH</code>，可以看到发送后余额发生变化。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n5. 调用multiTransferToken()函数，给每个钱包转 0.0001 WETH"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// 先approve WETH给Airdrop合约</span></span>
<span class="line"><span class="token keyword">const</span> txApprove <span class="token operator">=</span> <span class="token keyword">await</span> contractWETH<span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span>addressAirdrop<span class="token punctuation">,</span> ethers<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">await</span> txApprove<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// 发起交易</span></span>
<span class="line"><span class="token keyword">const</span> tx2 <span class="token operator">=</span> <span class="token keyword">await</span> contractAirdrop<span class="token punctuation">.</span><span class="token function">multiTransferToken</span><span class="token punctuation">(</span>addressWETH<span class="token punctuation">,</span> addresses<span class="token punctuation">,</span> amounts<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// 等待交易上链</span></span>
<span class="line"><span class="token keyword">await</span> tx2<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// console.log(`交易详情：`)</span></span>
<span class="line"><span class="token comment">// console.log(tx2)</span></span>
<span class="line"><span class="token comment">// 读取WETH余额</span></span>
<span class="line"><span class="token keyword">const</span> balanceWETH2 <span class="token operator">=</span> <span class="token keyword">await</span> contractWETH<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>addresses<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">发送后该钱包WETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceWETH2<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="@source/ethers/img/15-5.png" alt="批量发送WETH"></p>
</li>
</ol>
<h2 id="完整代码" tabindex="-1"><a class="header-anchor" href="#完整代码"><span>完整代码</span></a></h2>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> ethers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"ethers"</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 1. 创建HD钱包</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n1. 创建HD钱包"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// 通过助记词生成HD钱包</span></span>
<span class="line"><span class="token keyword">const</span> mnemonic <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">air organ twist rule prison symptom jazz cheap rather dizzy verb glare jeans orbit weapon universe require tired sing casino business anxiety seminar hunt</span><span class="token template-punctuation string">`</span></span></span>
<span class="line"><span class="token keyword">const</span> hdNode <span class="token operator">=</span> ethers<span class="token punctuation">.</span>HDNodeWallet<span class="token punctuation">.</span><span class="token function">fromPhrase</span><span class="token punctuation">(</span>mnemonic<span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hdNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 2. 获得20个钱包的地址</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n2. 通过HD钱包派生20个钱包"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> numWallet <span class="token operator">=</span> <span class="token number">20</span></span>
<span class="line"><span class="token comment">// 派生路径：m / purpose' / coin_type' / account' / change / address_index</span></span>
<span class="line"><span class="token comment">// 我们只需要切换最后一位address_index，就可以从hdNode派生出新钱包</span></span>
<span class="line"><span class="token keyword">let</span> basePath <span class="token operator">=</span> <span class="token string">"m/44'/60'/0'/0"</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> addresses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numWallet<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> hdNodeNew <span class="token operator">=</span> hdNode<span class="token punctuation">.</span><span class="token function">derivePath</span><span class="token punctuation">(</span>basePath <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> walletNew <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Wallet</span><span class="token punctuation">(</span>hdNodeNew<span class="token punctuation">.</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    addresses<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>walletNew<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>addresses<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> amounts <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>ethers<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"0.0001"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">发送数额：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>amounts<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 3. 创建provider和wallet，发送代币用</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token constant">ALCHEMY_GOERLI_URL</span> <span class="token operator">=</span> <span class="token string">'https://eth-goerli.alchemyapi.io/v2/GlaeWuylnNM3uuOo-SAwJxuwTdqHaY5l'</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>JsonRpcProvider</span><span class="token punctuation">(</span><span class="token constant">ALCHEMY_GOERLI_URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 利用私钥和provider创建wallet对象</span></span>
<span class="line"><span class="token comment">// 如果这个钱包没goerli测试网ETH了</span></span>
<span class="line"><span class="token comment">// 请使用自己的小号钱包测试，钱包地址: 0x338f8891D6BdC58eEB4754352459cC461EfD2a5E ,请不要给此地址发送任何ETH</span></span>
<span class="line"><span class="token comment">// 注意不要把自己的私钥上传到github上</span></span>
<span class="line"><span class="token keyword">const</span> privateKey <span class="token operator">=</span> <span class="token string">'0x227dbb8586117d55284e26620bc76534dfbd2394be34cf4a09cb775d593b6f2b'</span></span>
<span class="line"><span class="token keyword">const</span> wallet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Wallet</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">,</span> provider<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 4. 声明Airdrop合约</span></span>
<span class="line"><span class="token comment">// Airdrop的ABI</span></span>
<span class="line"><span class="token keyword">const</span> abiAirdrop <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">"function multiTransferToken(address,address[],uint256[]) external"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">"function multiTransferETH(address[],uint256[]) public payable"</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// Airdrop合约地址（Goerli测试网）</span></span>
<span class="line"><span class="token keyword">const</span> addressAirdrop <span class="token operator">=</span> <span class="token string">'0x71C2aD976210264ff0468d43b198FD69772A25fa'</span> <span class="token comment">// Airdrop Contract</span></span>
<span class="line"><span class="token comment">// 声明Airdrop合约</span></span>
<span class="line"><span class="token keyword">const</span> contractAirdrop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Contract</span><span class="token punctuation">(</span>addressAirdrop<span class="token punctuation">,</span> abiAirdrop<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 5. 声明WETH合约</span></span>
<span class="line"><span class="token comment">// WETH的ABI</span></span>
<span class="line"><span class="token keyword">const</span> abiWETH <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">"function balanceOf(address) public view returns(uint)"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">"function transfer(address, uint) public returns (bool)"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">"function approve(address, uint256) public returns (bool)"</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// WETH合约地址（Goerli测试网）</span></span>
<span class="line"><span class="token keyword">const</span> addressWETH <span class="token operator">=</span> <span class="token string">'0xB4FBF271143F4FBf7B91A5ded31805e42b2208d6'</span> <span class="token comment">// WETH Contract</span></span>
<span class="line"><span class="token comment">// 声明WETH合约</span></span>
<span class="line"><span class="token keyword">const</span> contractWETH <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Contract</span><span class="token punctuation">(</span>addressWETH<span class="token punctuation">,</span> abiWETH<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 6. 读取一个地址的ETH和WETH余额</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n3. 读取一个地址的ETH和WETH余额"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">//读取WETH余额</span></span>
<span class="line">    <span class="token keyword">const</span> balanceWETH <span class="token operator">=</span> <span class="token keyword">await</span> contractWETH<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>addresses<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">WETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceWETH<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">//读取ETH余额</span></span>
<span class="line">    <span class="token keyword">const</span> balanceETH <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span>addresses<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceETH<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> myETH <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span>wallet<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> myToken <span class="token operator">=</span> <span class="token keyword">await</span> contractWETH<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>wallet<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 如果钱包ETH足够和WETH足够</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>myETH<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.002</span> <span class="token operator">&amp;&amp;</span> ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>myToken<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0.002</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 7. 调用multiTransferETH()函数，给每个钱包转 0.0001 ETH</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n4. 调用multiTransferETH()函数，给每个钱包转 0.0001 ETH"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// 发起交易</span></span>
<span class="line">        <span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> contractAirdrop<span class="token punctuation">.</span><span class="token function">multiTransferETH</span><span class="token punctuation">(</span>addresses<span class="token punctuation">,</span> amounts<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> ethers<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"0.002"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// 等待交易上链</span></span>
<span class="line">        <span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// console.log(`交易详情：`)</span></span>
<span class="line">        <span class="token comment">// console.log(tx)</span></span>
<span class="line">        <span class="token keyword">const</span> balanceETH2 <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span>addresses<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">发送后该钱包ETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceETH2<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 8. 调用multiTransferToken()函数，给每个钱包转 0.0001 WETH</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n5. 调用multiTransferToken()函数，给每个钱包转 0.0001 WETH"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// 先approve WETH给Airdrop合约</span></span>
<span class="line">        <span class="token keyword">const</span> txApprove <span class="token operator">=</span> <span class="token keyword">await</span> contractWETH<span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span>addressAirdrop<span class="token punctuation">,</span> ethers<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">await</span> txApprove<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// 发起交易</span></span>
<span class="line">        <span class="token keyword">const</span> tx2 <span class="token operator">=</span> <span class="token keyword">await</span> contractAirdrop<span class="token punctuation">.</span><span class="token function">multiTransferToken</span><span class="token punctuation">(</span>addressWETH<span class="token punctuation">,</span> addresses<span class="token punctuation">,</span> amounts<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// 等待交易上链</span></span>
<span class="line">        <span class="token keyword">await</span> tx2<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// console.log(`交易详情：`)</span></span>
<span class="line">        <span class="token comment">// console.log(tx2)</span></span>
<span class="line">        <span class="token comment">// 读取WETH余额</span></span>
<span class="line">        <span class="token keyword">const</span> balanceWETH2 <span class="token operator">=</span> <span class="token keyword">await</span> contractWETH<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>addresses<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">发送后该钱包WETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceWETH2<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 如果ETH和WETH不足</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"ETH不足，请使用自己的小号钱包测试，并兑换一些WETH"</span><span class="token punctuation">)</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"1. chainlink水龙头: https://faucets.chain.link/goerli"</span><span class="token punctuation">)</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"2. paradigm水龙头: https://faucet.paradigm.xyz/"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div></template>


