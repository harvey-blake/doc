<template><div><h1 id="_16-批量归集" tabindex="-1"><a class="header-anchor" href="#_16-批量归集"><span>16. 批量归集</span></a></h1>
<p>这一讲，我们介绍如何使用<code v-pre>ethers.js</code>将多个钱包的<code v-pre>ETH</code>和代币归集到一个钱包中。</p>
<h2 id="批量归集" tabindex="-1"><a class="header-anchor" href="#批量归集"><span>批量归集</span></a></h2>
<p>在链上交互、撸毛之后，就需要将多个钱包的资产进行归集管理。你可以用<RouteLink to="/ethers/HDwallet.html">HD钱包</RouteLink>或者保存多份密钥的方式操作多个钱包，然后用<code v-pre>ethers.js</code>脚本完成归集。下面我们分别示范归集<code v-pre>ETH</code>（原生代币）和<code v-pre>WETH</code>（ERC20代币）。</p>
<ol>
<li>
<p>创建<code v-pre>provider</code>和<code v-pre>wallet</code>，其中<code v-pre>wallet</code>是接收资产的钱包。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token constant">ALCHEMY_GOERLI_URL</span> <span class="token operator">=</span> <span class="token string">'https://eth-goerli.alchemyapi.io/v2/GlaeWuylnNM3uuOo-SAwJxuwTdqHaY5l'</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>JsonRpcProvider</span><span class="token punctuation">(</span><span class="token constant">ALCHEMY_GOERLI_URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 利用私钥和provider创建wallet对象</span></span>
<span class="line"><span class="token keyword">const</span> privateKey <span class="token operator">=</span> <span class="token string">'0x21ac72b6ce19661adf31ef0d2bf8c3fcad003deee3dc1a1a64f5fa3d6b049c06'</span></span>
<span class="line"><span class="token keyword">const</span> wallet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Wallet</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">,</span> provider<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li>
<p>声明WETH合约。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token comment">// WETH的ABI</span></span>
<span class="line"><span class="token keyword">const</span> abiWETH <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">"function balanceOf(address) public view returns(uint)"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">"function transfer(address, uint) public returns (bool)"</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// WETH合约地址（Goerli测试网）</span></span>
<span class="line"><span class="token keyword">const</span> addressWETH <span class="token operator">=</span> <span class="token string">'0xB4FBF271143F4FBf7B91A5ded31805e42b2208d6'</span> <span class="token comment">// WETH Contract</span></span>
<span class="line"><span class="token comment">// 声明WETH合约</span></span>
<span class="line"><span class="token keyword">const</span> contractWETH <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Contract</span><span class="token punctuation">(</span>addressWETH<span class="token punctuation">,</span> abiWETH<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li>
<p>创建<code v-pre>HD</code>钱包，用于管理多个钱包。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n1. 创建HD钱包"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// 通过助记词生成HD钱包</span></span>
<span class="line"><span class="token keyword">const</span> mnemonic <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">air organ twist rule prison symptom jazz cheap rather dizzy verb glare jeans orbit weapon universe require tired sing casino business anxiety seminar hunt</span><span class="token template-punctuation string">`</span></span></span>
<span class="line"><span class="token keyword">const</span> hdNode <span class="token operator">=</span> ethers<span class="token punctuation">.</span>HDNodeWallet<span class="token punctuation">.</span><span class="token function">fromPhrase</span><span class="token punctuation">(</span>mnemonic<span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hdNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="@source/ethers/img/16-1.png" alt="HD钱包"></p>
</li>
<li>
<p>通过<code v-pre>HD</code>钱包衍生<code v-pre>20</code>个钱包，这些钱包上需要有资产。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token keyword">const</span> numWallet <span class="token operator">=</span> <span class="token number">20</span></span>
<span class="line"><span class="token comment">// 派生路径：m / purpose' / coin_type' / account' / change / address_index</span></span>
<span class="line"><span class="token comment">// 我们只需要切换最后一位address_index，就可以从hdNode派生出新钱包</span></span>
<span class="line"><span class="token keyword">let</span> basePath <span class="token operator">=</span> <span class="token string">"m/44'/60'/0'/0"</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> wallets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numWallet<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> hdNodeNew <span class="token operator">=</span> hdNode<span class="token punctuation">.</span><span class="token function">derivePath</span><span class="token punctuation">(</span>basePath <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> walletNew <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Wallet</span><span class="token punctuation">(</span>hdNodeNew<span class="token punctuation">.</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    wallets<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>walletNew<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>walletNew<span class="token punctuation">.</span>address<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// 定义发送数额</span></span>
<span class="line"><span class="token keyword">const</span> amount <span class="token operator">=</span> ethers<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"0.0001"</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">发送数额：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>amount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="@source/ethers/img/16-2.png" alt="生成20个地址"></p>
</li>
<li>
<p>读取一个地址的ETH和WETH余额。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n3. 读取一个地址的ETH和WETH余额"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">//读取WETH余额</span></span>
<span class="line"><span class="token keyword">const</span> balanceWETH <span class="token operator">=</span> <span class="token keyword">await</span> contractWETH<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>wallets<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">WETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceWETH<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">//读取ETH余额</span></span>
<span class="line"><span class="token keyword">const</span> balanceETH <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span>wallets<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceETH<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="@source/ethers/img/16-3.png" alt="读取余额"></p>
</li>
<li>
<p>利用钱包类的<code v-pre>sendTransaction()</code>发送交易，归集每个钱包中的<code v-pre>ETH</code>。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token comment">// 6. 批量归集钱包的ETH</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n4. 批量归集20个钱包的ETH"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> txSendETH <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">to</span><span class="token operator">:</span> wallet<span class="token punctuation">.</span>address<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">value</span><span class="token operator">:</span> amount</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numWallet<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 将钱包连接到provider</span></span>
<span class="line">    <span class="token keyword">let</span> walletiWithProvider <span class="token operator">=</span> wallets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">var</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> walletiWithProvider<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span>txSendETH<span class="token punctuation">)</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">第 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个钱包 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>walletiWithProvider<span class="token punctuation">.</span>address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ETH 归集开始</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ETH 归集结束</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="@source/ethers/img/16-4.png" alt="归集ETH"></p>
</li>
<li>
<p>将<code v-pre>WETH</code>合约连接到新的钱包，然后调用<code v-pre>transfer()</code>方法归集每个钱包的<code v-pre>WETH</code>。</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numWallet<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 将钱包连接到provider</span></span>
<span class="line">    <span class="token keyword">let</span> walletiWithProvider <span class="token operator">=</span> wallets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 将合约连接到新的钱包</span></span>
<span class="line">    <span class="token keyword">let</span> contractConnected <span class="token operator">=</span> contractWETH<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>walletiWithProvider<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">var</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> contractConnected<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>wallet<span class="token punctuation">.</span>address<span class="token punctuation">,</span> amount<span class="token punctuation">)</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">第 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个钱包 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wallets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> WETH 归集开始</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">WETH 归集结束</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="@source/ethers/img/16-5.png" alt="归集WETH"></p>
</li>
<li>
<p>读取一个地址在归集后的ETH和WETH余额，可以看到<code v-pre>ETH</code>和<code v-pre>WETH</code>余额减少，归集成功！</p>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n6. 读取一个地址在归集后的ETH和WETH余额"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// 读取WETH余额</span></span>
<span class="line"><span class="token keyword">const</span> balanceWETHAfter <span class="token operator">=</span> <span class="token keyword">await</span> contractWETH<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>wallets<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">归集后WETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethersfromPhrase<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceWETHAfter<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// 读取ETH余额</span></span>
<span class="line"><span class="token keyword">const</span> balanceETHAfter <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span>wallets<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">归集后ETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethersfromPhrase<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceETHAfter<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="@source/ethers/img/16-6.png" alt="归集后余额变动"></p>
</li>
</ol>
<h2 id="完整代码" tabindex="-1"><a class="header-anchor" href="#完整代码"><span>完整代码</span></a></h2>
<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre v-pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> ethers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"ethers"</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 1. 创建provider和wallet，发送代币用</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token constant">ALCHEMY_GOERLI_URL</span> <span class="token operator">=</span> <span class="token string">'https://eth-goerli.alchemyapi.io/v2/GlaeWuylnNM3uuOo-SAwJxuwTdqHaY5l'</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>JsonRpcProvider</span><span class="token punctuation">(</span><span class="token constant">ALCHEMY_GOERLI_URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 利用私钥和provider创建wallet对象</span></span>
<span class="line"><span class="token keyword">const</span> privateKey <span class="token operator">=</span> <span class="token string">'0x21ac72b6ce19661adf31ef0d2bf8c3fcad003deee3dc1a1a64f5fa3d6b049c06'</span></span>
<span class="line"><span class="token keyword">const</span> wallet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Wallet</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">,</span> provider<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 2. 声明WETH合约</span></span>
<span class="line"><span class="token comment">// WETH的ABI</span></span>
<span class="line"><span class="token keyword">const</span> abiWETH <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">"function balanceOf(address) public view returns(uint)"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">"function transfer(address, uint) public returns (bool)"</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// WETH合约地址（Goerli测试网）</span></span>
<span class="line"><span class="token keyword">const</span> addressWETH <span class="token operator">=</span> <span class="token string">'0xB4FBF271143F4FBf7B91A5ded31805e42b2208d6'</span> <span class="token comment">// WETH Contract</span></span>
<span class="line"><span class="token comment">// 声明WETH合约</span></span>
<span class="line"><span class="token keyword">const</span> contractWETH <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Contract</span><span class="token punctuation">(</span>addressWETH<span class="token punctuation">,</span> abiWETH<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 3. 创建HD钱包</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n1. 创建HD钱包"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// 通过助记词生成HD钱包</span></span>
<span class="line"><span class="token keyword">const</span> mnemonic <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">air organ twist rule prison symptom jazz cheap rather dizzy verb glare jeans orbit weapon universe require tired sing casino business anxiety seminar hunt</span><span class="token template-punctuation string">`</span></span></span>
<span class="line"><span class="token keyword">const</span> hdNode <span class="token operator">=</span> ethers<span class="token punctuation">.</span>HDNodeWallet<span class="token punctuation">.</span><span class="token function">fromPhrase</span><span class="token punctuation">(</span>mnemonic<span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hdNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 4. 获得20个钱包</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n2. 通过HD钱包派生20个钱包"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> numWallet <span class="token operator">=</span> <span class="token number">20</span></span>
<span class="line"><span class="token comment">// 派生路径：m / purpose' / coin_type' / account' / change / address_index</span></span>
<span class="line"><span class="token comment">// 我们只需要切换最后一位address_index，就可以从hdNode派生出新钱包</span></span>
<span class="line"><span class="token keyword">let</span> basePath <span class="token operator">=</span> <span class="token string">"m/44'/60'/0'/0"</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> wallets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numWallet<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> hdNodeNew <span class="token operator">=</span> hdNode<span class="token punctuation">.</span><span class="token function">derivePath</span><span class="token punctuation">(</span>basePath <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> walletNew <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Wallet</span><span class="token punctuation">(</span>hdNodeNew<span class="token punctuation">.</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    wallets<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>walletNew<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>walletNew<span class="token punctuation">.</span>address<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// 定义发送数额</span></span>
<span class="line"><span class="token keyword">const</span> amount <span class="token operator">=</span> ethers<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"0.0001"</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">发送数额：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>amount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 5. 读取一个地址的ETH和WETH余额</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n3. 读取一个地址的ETH和WETH余额"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">//读取WETH余额</span></span>
<span class="line">    <span class="token keyword">const</span> balanceWETH <span class="token operator">=</span> <span class="token keyword">await</span> contractWETH<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>wallets<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">WETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceWETH<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">//读取ETH余额</span></span>
<span class="line">    <span class="token keyword">const</span> balanceETH <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span>wallets<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceETH<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 如果钱包ETH足够</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceETH<span class="token punctuation">)</span> <span class="token operator">></span> ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">    ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceWETH<span class="token punctuation">)</span> <span class="token operator">>=</span> ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 6. 批量归集钱包的ETH</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n4. 批量归集20个钱包的ETH"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">const</span> txSendETH <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">to</span><span class="token operator">:</span> wallet<span class="token punctuation">.</span>address<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">value</span><span class="token operator">:</span> amount</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numWallet<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 将钱包连接到provider</span></span>
<span class="line">            <span class="token keyword">let</span> walletiWithProvider <span class="token operator">=</span> wallets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">var</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> walletiWithProvider<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span>txSendETH<span class="token punctuation">)</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">第 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个钱包 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>walletiWithProvider<span class="token punctuation">.</span>address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ETH 归集开始</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ETH 归集结束</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 7. 批量归集钱包的WETH</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n5. 批量归集20个钱包的WETH"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numWallet<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 将钱包连接到provider</span></span>
<span class="line">            <span class="token keyword">let</span> walletiWithProvider <span class="token operator">=</span> wallets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// 将合约连接到新的钱包</span></span>
<span class="line">            <span class="token keyword">let</span> contractConnected <span class="token operator">=</span> contractWETH<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>walletiWithProvider<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">var</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> contractConnected<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>wallet<span class="token punctuation">.</span>address<span class="token punctuation">,</span> amount<span class="token punctuation">)</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">第 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个钱包 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wallets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> WETH 归集开始</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">WETH 归集结束</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 8. 读取一个地址在归集后的ETH和WETH余额</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\n6. 读取一个地址在归集后的ETH和WETH余额"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// 读取WETH余额</span></span>
<span class="line">        <span class="token keyword">const</span> balanceWETHAfter <span class="token operator">=</span> <span class="token keyword">await</span> contractWETH<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>wallets<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">归集后WETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceWETHAfter<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// 读取ETH余额</span></span>
<span class="line">        <span class="token keyword">const</span> balanceETHAfter <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span>wallets<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">归集后ETH持仓: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ethers<span class="token punctuation">.</span><span class="token function">formatEther</span><span class="token punctuation">(</span>balanceETHAfter<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div></template>


